<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å…‹æ•™ç­æ—¥æœŸ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin-top: 30px; }
        .header-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #calendar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); min-height: 800px; }
        
        /* é‡å°è¡Œäº‹æ›†äº‹ä»¶çš„æ¨£å¼ */
        .fc-event { cursor: pointer; border: none; }
        .fc-event-title { font-weight: bold; }
        .tag-tutor { background-color: #e3f2fd; color: #0d47a1; border-radius: 4px; padding: 2px 4px; font-size: 0.85em; margin-right: 5px; }
        
        /* Loading é®ç½© */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">æ­£åœ¨è®€å–æ´¾å…‹å°å¸«è³‡æ–™...</p>
    </div>

    <div class="container">
        <div class="header-box">
            <h2 class="mb-4 text-center fw-bold text-primary"><i class="bi bi-calendar-check"></i> æ´¾å…‹å°å¸«æç¤ºå™¨</h2>
            
            <div class="row g-3 align-items-end mb-4 border-bottom pb-4">
                <div class="col-md-4">
                    <label for="promptDate" class="form-label fw-bold">é¸æ“‡æç¤ºæ—¥æœŸ</label>
                    <input type="date" id="promptDate" class="form-control">
                </div>
                <div class="col-md-8">
                    <button class="btn btn-success w-100" onclick="generatePrompt()">
                        <i class="bi bi-chat-text"></i> ç”Ÿæˆæç¤ºå­—å¥çš„
                    </button>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">é¸å–å°å¸«</label>
                    <select id="filterTutor" class="form-select">
                        <option value="all">é¡¯ç¤ºæ‰€æœ‰å°å¸«</option>
                        </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">é¸å–èª²ç¨‹</label>
                    <select id="filterCourse" class="form-select">
                        <option value="all">é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹</option>
                        </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">é¡¯ç¤ºé€±/æœˆ</label>
                    <select id="viewSelect" class="form-select">
                        <option value="dayGridMonth">æœˆæ›†è¦–åœ– (Month)</option>
                        <option value="listWeek">é€±åˆ—è¡¨ (Week List)</option>
                        <option value="timeGridWeek">é€±æ™‚é–“è¡¨ (Week Grid)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="calendar"></div>
    </div>

    <div class="modal fade" id="promptModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">æç¤ºå­—å¥ç”Ÿæˆçµæœ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="promptResult" class="form-control" rows="8"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                    <button type="button" class="btn btn-primary" onclick="copyToClipboard()">è¤‡è£½æ–‡å­—</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQFFF43IJhu4qgR8KiR_Oo9lwv7LkuTcjHzebpTvUd-SnnivG_5GwDT3-JzEncLTxKXbZuQ8LnU90n3/pub?output=csv';
        
        let allEvents = []; // å„²å­˜æ‰€æœ‰è™•ç†éçš„èª²ç¨‹è³‡æ–™
        let calendar; // FullCalendar å¯¦ä¾‹

        // ç•¶é é¢è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­å®šæ—¥æœŸé¸æ“‡å™¨é è¨­ç‚ºä»Šå¤©
            document.getElementById('promptDate').valueAsDate = new Date();

            // åˆå§‹åŒ–è¡Œäº‹æ›†
            initCalendar();
            
            // è®€å–è³‡æ–™
            fetchData();

            // ç›£è½ç¯©é¸å™¨è®Šæ›´
            document.getElementById('filterTutor').addEventListener('change', refreshCalendar);
            document.getElementById('filterCourse').addEventListener('change', refreshCalendar);
            document.getElementById('viewSelect').addEventListener('change', function() {
                calendar.changeView(this.value);
            });
        });

        // 1. åˆå§‹åŒ– FullCalendar
        function initCalendar() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: '' // éš±è—åŸæœ¬çš„åˆ‡æ›æŒ‰éˆ•ï¼Œæ”¹ç”¨ä¸‹æ‹‰é¸å–®æ§åˆ¶
                },
                eventClick: function(info) {
                    alert(`è©³ç´°è³‡è¨Šï¼š\n\nå­¸æ ¡ï¼š${info.event.extendedProps.school}\nèª²ç¨‹ï¼š${info.event.extendedProps.course}\næ™‚é–“ï¼š${info.event.extendedProps.timeStr}\nå°å¸«ï¼š${info.event.extendedProps.tutor}`);
                },
                eventContent: function(arg) {
                    // è‡ªå®šç¾©é¡¯ç¤ºå…§å®¹
                    let timeText = arg.event.extendedProps.timeStr || '';
                    let tutorName = arg.event.extendedProps.tutor;
                    let schoolName = arg.event.extendedProps.school;
                    
                    return {
                        html: `<div style="font-size:0.85rem;">
                                <span class="tag-tutor">${tutorName}</span><br>
                                <b>${timeText}</b> ${schoolName}
                               </div>`
                    };
                }
            });
            calendar.render();
        }

        // 2. è®€å–èˆ‡è§£æè³‡æ–™
        function fetchData() {
            Papa.parse(GOOGLE_SHEET_CSV_URL, {
                download: true,
                header: false, // å‡è¨­ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œï¼Œä½†æˆ‘å€‘ç”¨ç´¢å¼•è®€å–æ¯”è¼ƒå®‰å…¨
                complete: function(results) {
                    processData(results.data);
                    document.getElementById('loading').style.display = 'none';
                },
                error: function(err) {
                    alert("è®€å– Google Sheet å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµã€‚");
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        // 3. è³‡æ–™è™•ç†é‚è¼¯
        function processData(rows) {
            // æ¬„ä½å°æ‡‰: A=0(å­¸æ ¡), B=1(èª²ç¨‹), C=2(å ‚æ•¸), D=3(æ—¥æœŸ), E=4(æ˜ŸæœŸ), F=5(æ™‚é–“), G=6(å°å¸«)
            
            let tutors = new Set();
            let courses = new Set();

            // å¾ç¬¬ 1 è¡Œé–‹å§‹ (è·³éæ¨™é¡Œè¡Œ Index 0)
            for (let i = 1; i < rows.length; i++) {
                let col = rows[i];
                if (!col[0] || !col[3]) continue; // ç•¥éç©ºè¡Œ

                let rawDate = col[3]; // 2026å¹´2æœˆ6æ—¥
                let parsedDate = parseChineseDate(rawDate);
                
                if (parsedDate) {
                    let eventObj = {
                        id: i,
                        title: `${col[0]} - ${col[1]}`, // å­¸æ ¡ - èª²ç¨‹
                        start: parsedDate, // ç”¨æ–¼è¡Œäº‹æ›†å®šä½
                        allDay: true, // å› ç‚ºæ™‚é–“æ ¼å¼å¯èƒ½ä¸æ¨™æº–ï¼Œæˆ‘å€‘å…ˆè¨­ç‚ºå…¨å¤©ï¼Œæ™‚é–“é¡¯ç¤ºåœ¨æ–‡å­—ä¸­
                        // è‡ªå®šç¾©å±¬æ€§
                        school: col[0],
                        course: col[1],
                        session: col[2],
                        dateRaw: rawDate,
                        timeStr: col[5],
                        tutor: col[6],
                        // é¡è‰²å€åˆ†
                        backgroundColor: getColorByCourse(col[1]) 
                    };

                    allEvents.push(eventObj);
                    
                    // æ”¶é›†æ¸…å–®ç”¨æ–¼ä¸‹æ‹‰é¸å–®
                    if(col[6]) tutors.add(col[6]);
                    if(col[1]) courses.add(col[1]);
                }
            }

            populateSelect('filterTutor', tutors);
            populateSelect('filterCourse', courses);
            
            // åˆå§‹æ¸²æŸ“
            refreshCalendar();
        }

        // è¼”åŠ©ï¼šè§£æä¸­æ–‡æ—¥æœŸ (YYYYå¹´MæœˆDæ—¥ -> YYYY-MM-DD)
        function parseChineseDate(dateStr) {
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå–æ•¸å­—
            let match = dateStr.match(/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/);
            if (match) {
                let year = match[1];
                let month = match[2].padStart(2, '0');
                let day = match[3].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return null;
        }

        // è¼”åŠ©ï¼šå¡«å……ä¸‹æ‹‰é¸å–®
        function populateSelect(elementId, dataset) {
            let select = document.getElementById(elementId);
            let sortedData = Array.from(dataset).sort();
            sortedData.forEach(item => {
                let option = document.createElement('option');
                option.value = item;
                option.text = item;
                select.appendChild(option);
            });
        }

        // è¼”åŠ©ï¼šæ ¹æ“šèª²ç¨‹åç¨±çµ¦é¡è‰² (éš¨æ©Ÿç°¡å–®é›œæ¹Š)
        function getColorByCourse(courseName) {
            let hash = 0;
            for (let i = 0; i < courseName.length; i++) {
                hash = courseName.charCodeAt(i) + ((hash << 5) - hash);
            }
            let c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // 4. æ›´æ–°è¡Œäº‹æ›† (æ ¹æ“šç¯©é¸)
        function refreshCalendar() {
            let selectedTutor = document.getElementById('filterTutor').value;
            let selectedCourse = document.getElementById('filterCourse').value;

            let filteredEvents = allEvents.filter(event => {
                let matchTutor = (selectedTutor === 'all' || event.tutor === selectedTutor);
                let matchCourse = (selectedCourse === 'all' || event.course === selectedCourse);
                return matchTutor && matchCourse;
            });

            calendar.removeAllEvents();
            calendar.addEventSource(filteredEvents);
        }

        // 5. ç”Ÿæˆæç¤ºå­—å¥åŠŸèƒ½
        function generatePrompt() {
            let dateInput = document.getElementById('promptDate').value; // YYYY-MM-DD
            let selectedTutor = document.getElementById('filterTutor').value;

            if (!dateInput) {
                alert("è«‹é¸æ“‡æ—¥æœŸï¼");
                return;
            }

            // ç¯©é¸ç•¶æ—¥ä¸”ç¬¦åˆé¸å®šå°å¸«çš„èª²ç¨‹
            let targets = allEvents.filter(e => {
                let isDateMatch = e.start === dateInput;
                let isTutorMatch = (selectedTutor === 'all' || e.tutor === selectedTutor);
                return isDateMatch && isTutorMatch;
            });

            if (targets.length === 0) {
                alert("è©²æ—¥æœŸæ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„èª²ç¨‹è³‡æ–™ã€‚");
                return;
            }

            // æ§‹å»ºæ–‡å­—
            let text = `ã€æ´¾å…‹å°å¸«ä¸Šèª²æé†’ã€‘\næ—¥æœŸï¼š${dateInput}\n`;
            if (selectedTutor !== 'all') {
                text += `è‡´å°å¸«ï¼š${selectedTutor}\n`;
            }
            text += `------------------------\n`;

            targets.forEach(item => {
                text += `â° æ™‚é–“ï¼š${item.timeStr}\n`;
                text += `ğŸ« å­¸æ ¡ï¼š${item.school}\n`;
                text += `ğŸ“š èª²ç¨‹ï¼š${item.course} (ç¬¬${item.session}å ‚)\n`;
                text += `ğŸ‘¨â€ğŸ« å°å¸«ï¼š${item.tutor}\n`;
                text += `\n`;
            });
            text += `è«‹æº–æ™‚å‡ºå¸­ï¼Œè¬è¬ï¼`;

            // é¡¯ç¤º Modal
            document.getElementById('promptResult').value = text;
            new bootstrap.Modal(document.getElementById('promptModal')).show();
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿
        function copyToClipboard() {
            let copyText = document.getElementById("promptResult");
            copyText.select();
            document.execCommand("copy"); // å…¼å®¹èˆŠç‰ˆ
            
            // ç¾ä»£ç€è¦½å™¨å¯«æ³•
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText.value);
            }
            alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        }

    </script>
</body>
</html>
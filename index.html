<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´¾å…‹æ•™ç­æ—¥æœŸ - ç°¡ç´„ç‰ˆ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        /* å®šç¾©åƒè€ƒä»‹é¢çš„è‰²ç³» */
        :root {
            --primary-color: #2c3e50; /* æ·±è—è‰²åŸºèª¿ */
            --accent-color: #27ae60;  /* ç¶ è‰²å¼·èª¿æŒ‰éˆ• */
            --bg-light: #f4f7f6;      /* æ•´é«”æ·ºè‰²èƒŒæ™¯ */
            --card-border: #d6eaf8;   /* è¼•å¾®çš„é‚Šæ¡†è‰² */
        }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-light);
            color: var(--primary-color);
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        h2.page-title {
            color: var(--primary-color);
            font-weight: 700;
            text-align: center;
            margin-bottom: 25px;
        }

        /* æ¨¡ä»¿åƒè€ƒåœ–çš„æ§åˆ¶å€åŸŸæ¨£å¼ */
        .controls-box {
            background: #ebf5fb; /* æ¥µæ·ºè—è‰²èƒŒæ™¯ */
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--card-border);
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .form-control, .form-select {
            border: 1px solid #bdc3c7;
        }

        /* æŒ‰éˆ•æ¨£å¼é‡è¨­ */
        .btn-accent {
            background-color: var(--accent-color);
            border: none;
            color: white;
            font-weight: 600;
            padding: 8px 20px;
            transition: background-color 0.2s;
        }
        .btn-accent:hover {
            background-color: #219150; /* æ·±ä¸€é»çš„ç¶ è‰² */
            color: white;
        }

        /* FullCalendar æ¨£å¼è¦†å¯« - ç°¡ç´„åŒ– */
        #calendar {
            padding-top: 20px;
        }

        /* è¦†å¯« FullCalendar æŒ‰éˆ•é¡è‰²ç‚ºæ·±è—è‰² */
        .fc .fc-button-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .fc .fc-button-primary:hover {
            background-color: #1a252f;
            border-color: #1a252f;
        }
        .fc .fc-button-active {
            background-color: #1a252f !important;
            border-color: #1a252f !important;
        }
        
        /* è¡Œäº‹æ›†äº‹ä»¶å¡ç‰‡æ¨£å¼ - çµ±ä¸€ä¹¾æ·¨é¢¨æ ¼ */
        .fc-event {
            cursor: pointer;
            border: none;
            background-color: #ecf0f1; /* çµ±ä¸€æ·ºç°è‰²èƒŒæ™¯ */
            color: var(--primary-color) !important; /* æ·±è‰²æ–‡å­— */
            border-left: 3px solid var(--primary-color); /* å·¦å´åŠ ä¸€æ¢æ·±è—ç·šä½œè­˜åˆ¥ */
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 2px;
            padding: 2px 4px;
        }

        .event-time {
            font-weight: 700;
            color: var(--primary-color);
        }
        .event-tutor {
            font-size: 0.85em;
            color: #7f8c8d; /* ç¨å¾®æ·ºä¸€é»çš„ç°è‰² */
        }
        .event-school {
            font-size: 0.9em;
        }

        /* Modal æ¨£å¼å„ªåŒ– */
        .modal-header.bg-accent {
            background-color: var(--primary-color); /* Modal æ¨™é¡Œç”¨æ·±è— */
            color: white;
        }
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Loading é®ç½© */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--primary-color); }
    </style>
</head>
<body>

    <div id="loading">
        <div class="spinner-border" style="color: var(--primary-color);" role="status"></div>
        <p class="mt-3 fw-bold">æ­£åœ¨è®€å–è³‡æ–™...</p>
    </div>

    <div class="main-container">
        <h2 class="page-title"><i class="bi bi-calendar-week"></i> æ´¾å…‹å°å¸«ä¸Šèª²æ—¥ç¨‹è¡¨</h2>
        
        <div class="controls-box">
            <div class="row g-3 align-items-end mb-4 border-bottom border-2 pb-4">
                <div class="col-md-5">
                    <label for="promptDate" class="form-label"><i class="bi bi-chat-quote"></i> é¸æ“‡æç¤ºæ—¥æœŸï¼š</label>
                    <input type="date" id="promptDate" class="form-control">
                </div>
                <div class="col-md-7">
                    <button class="btn btn-accent w-100 py-2" onclick="generatePrompt()">
                        <i class="bi bi-whatsapp"></i> ç”Ÿæˆå°å¸«æç¤ºå­—å¥
                    </button>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-person-badge"></i> ç¯©é¸å°å¸«</label>
                    <select id="filterTutor" class="form-select">
                        <option value="all">é¡¯ç¤ºæ‰€æœ‰å°å¸«</option>
                        </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-book"></i> ç¯©é¸èª²ç¨‹</label>
                    <select id="filterCourse" class="form-select">
                        <option value="all">é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹</option>
                        </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label"><i class="bi bi-eye"></i> æª¢è¦–æ¨¡å¼</label>
                    <select id="viewSelect" class="form-select">
                        <option value="dayGridMonth">æœˆæ›†è¦–åœ– (Month)</option>
                        <option value="listWeek">é€±åˆ—è¡¨ (Week List)</option>
                        <option value="timeGridWeek">é€±æ™‚é–“è¡¨ (Week Grid)</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="calendar"></div>
    </div>

    <div class="modal fade" id="promptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-accent">
                    <h5 class="modal-title"><i class="bi bi-chat-text-fill"></i> æç¤ºå­—å¥é è¦½</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <textarea id="promptResult" class="form-control shadow-none" rows="10" style="font-family: monospace; border: 1px solid #dee2e6;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                    <button type="button" class="btn btn-accent" onclick="copyToClipboard()">
                        <i class="bi bi-clipboard-check"></i> è¤‡è£½æ–‡å­—
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQFFF43IJhu4qgR8KiR_Oo9lwv7LkuTcjHzebpTvUd-SnnivG_5GwDT3-JzEncLTxKXbZuQ8LnU90n3/pub?output=csv';
        
        let allEvents = []; // å„²å­˜æ‰€æœ‰è™•ç†éçš„èª²ç¨‹è³‡æ–™
        let calendar; // FullCalendar å¯¦ä¾‹

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('promptDate').valueAsDate = new Date();
            initCalendar();
            fetchData();
            setupEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½
        function setupEventListeners() {
            document.getElementById('filterTutor').addEventListener('change', refreshCalendar);
            document.getElementById('filterCourse').addEventListener('change', refreshCalendar);
            document.getElementById('viewSelect').addEventListener('change', function() {
                calendar.changeView(this.value);
            });
        }

        // 1. åˆå§‹åŒ– FullCalendar (ç°¡ç´„ç‰ˆè¨­å®š)
        function initCalendar() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: '' // éš±è—å³å´ï¼Œç”¨ä¸Šæ–¹ä¸‹æ‹‰é¸å–®å–ä»£
                },
                dayMaxEvents: true, // äº‹ä»¶å¤ªå¤šæ™‚æ‘ºç–Š
                eventClick: function(info) {
                    // é»æ“Šäº‹ä»¶æ™‚çš„ç°¡å–®æç¤ºï¼Œå¯è‡ªè¡Œæ“´å……ç‚º Modal
                    const props = info.event.extendedProps;
                    alert(`ã€èª²ç¨‹è©³æƒ…ã€‘\n\nå°å¸«ï¼š${props.tutor}\næ—¥æœŸï¼š${props.dateRaw}\næ™‚é–“ï¼š${props.timeStr}\nå­¸æ ¡ï¼š${props.school}\nèª²ç¨‹ï¼š${props.course} (ç¬¬${props.session}å ‚)`);
                },
                eventContent: function(arg) {
                    // ç°¡åŒ–å¾Œçš„è‡ªå®šç¾©é¡¯ç¤ºå…§å®¹ (ç§»é™¤é¡è‰²æ¨™ç±¤)
                    let timeText = arg.event.extendedProps.timeStr || '';
                    let tutorName = arg.event.extendedProps.tutor;
                    let schoolName = arg.event.extendedProps.school;
                    
                    // ä½¿ç”¨æ›´ä¹¾æ·¨çš„ HTML çµæ§‹
                    return {
                        html: `<div style="padding: 1px 0;">
                                <div class="event-time">${timeText} <span class="event-tutor">| ${tutorName}</span></div>
                                <div class="event-school text-truncate">${schoolName}</div>
                               </div>`
                    };
                }
            });
            calendar.render();
        }

        // 2. è®€å–èˆ‡è§£æè³‡æ–™
        function fetchData() {
            Papa.parse(GOOGLE_SHEET_CSV_URL, {
                download: true,
                header: false, 
                complete: function(results) {
                    processData(results.data);
                    document.getElementById('loading').style.display = 'none';
                },
                error: function(err) {
                    alert("è®€å– Google Sheet å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡ã€‚");
                    document.getElementById('loading').style.display = 'none';
                }
            });
        }

        // 3. è³‡æ–™è™•ç†é‚è¼¯
        function processData(rows) {
            let tutors = new Set();
            let courses = new Set();

            // å¾ç¬¬ 1 è¡Œé–‹å§‹ (è·³éæ¨™é¡Œè¡Œ Index 0)
            for (let i = 1; i < rows.length; i++) {
                let col = rows[i];
                // åŸºæœ¬æª¢æ ¸ï¼šç¢ºä¿æœ‰å­¸æ ¡(A=0)å’Œæ—¥æœŸ(D=3)
                if (!col[0] || !col[3] || col.length < 7) continue; 

                let rawDate = col[3]; // æ ¼å¼ï¼š2026å¹´2æœˆ6æ—¥
                let parsedDate = parseChineseDate(rawDate);
                
                if (parsedDate) {
                    let eventObj = {
                        id: 'evt_' + i,
                        // FullCalendar åŸºæœ¬å±¬æ€§
                        title: col[0], // æ¨™é¡Œåªæ”¾å­¸æ ¡ï¼Œä¿æŒç°¡æ½”
                        start: parsedDate, 
                        allDay: true, // è¨­ç‚ºå…¨å¤©ï¼Œè©³ç´°æ™‚é–“åœ¨å…§å®¹é¡¯ç¤º
                        // è‡ªå®šç¾©æ“´å……å±¬æ€§
                        school: col[0], // Aè¡Œ
                        course: col[1], // Bè¡Œ
                        session: col[2],// Cè¡Œ
                        dateRaw: rawDate,// Dè¡ŒåŸå§‹
                        timeStr: col[5],// Fè¡Œ
                        tutor: col[6]   // Gè¡Œ
                        // æ³¨æ„ï¼šç§»é™¤äº† backgroundColor çš„è¨­å®šï¼Œä½¿ç”¨ CSS çµ±ä¸€æ§åˆ¶
                    };

                    allEvents.push(eventObj);
                    
                    if(col[6]) tutors.add(col[6].trim());
                    if(col[1]) courses.add(col[1].trim());
                }
            }

            populateSelect('filterTutor', tutors);
            populateSelect('filterCourse', courses);
            refreshCalendar();
        }

        // è¼”åŠ©ï¼šè§£æä¸­æ–‡æ—¥æœŸ
        function parseChineseDate(dateStr) {
            if (!dateStr) return null;
            const matches = dateStr.match(/(\d+)å¹´(\d+)æœˆ(\d+)æ—¥/);
            if (matches) {
                return `${matches[1]}-${matches[2].padStart(2, '0')}-${matches[3].padStart(2, '0')}`;
            }
            return null;
        }

        // è¼”åŠ©ï¼šå¡«å……ä¸‹æ‹‰é¸å–®
        function populateSelect(elementId, dataset) {
            let select = document.getElementById(elementId);
            // æ¸…ç©ºèˆŠé¸é … (ä¿ç•™ç¬¬ä¸€å€‹)
            while (select.options.length > 1) { select.remove(1); }
            
            Array.from(dataset).sort().forEach(item => {
                if(item) {
                   let option = document.createElement('option');
                   option.value = item;
                   option.text = item;
                   select.appendChild(option);
                }
            });
        }

        // 4. æ›´æ–°è¡Œäº‹æ›† (æ ¹æ“šç¯©é¸)
        function refreshCalendar() {
            let selectedTutor = document.getElementById('filterTutor').value;
            let selectedCourse = document.getElementById('filterCourse').value;

            let filteredEvents = allEvents.filter(event => {
                let matchTutor = (selectedTutor === 'all' || event.tutor === selectedTutor);
                let matchCourse = (selectedCourse === 'all' || event.course === selectedCourse);
                return matchTutor && matchCourse;
            });

            calendar.removeAllEvents();
            calendar.addEventSource(filteredEvents);
        }

        // 5. ç”Ÿæˆæç¤ºå­—å¥åŠŸèƒ½
        function generatePrompt() {
            let dateInput = document.getElementById('promptDate').value; // YYYY-MM-DD
            let selectedTutor = document.getElementById('filterTutor').value;

            if (!dateInput) {
                alert("è«‹å…ˆé¸æ“‡æç¤ºæ—¥æœŸï¼");
                return;
            }

            // ç¯©é¸ç›®æ¨™
            let targets = allEvents.filter(e => {
                let isDateMatch = e.start === dateInput;
                let isTutorMatch = (selectedTutor === 'all' || e.tutor === selectedTutor);
                return isDateMatch && isTutorMatch;
            });

            if (targets.length === 0) {
                alert(`åœ¨ ${dateInput} æ‰¾ä¸åˆ°ç¬¦åˆç›®å‰ç¯©é¸æ¢ä»¶çš„èª²å ‚ã€‚`);
                return;
            }

            // ä¾ç…§æ™‚é–“æ’åº
            targets.sort((a, b) => {
                return a.timeStr.localeCompare(b.timeStr);
            });

            // æ§‹å»ºæ–‡å­—
            let text = `ã€æ´¾å…‹å°å¸«ä¸Šèª²æé†’ã€‘\nğŸ“… æ—¥æœŸï¼š${dateInput}\n`;
            if (selectedTutor !== 'all') {
                text += `ğŸ‘¤ è‡´å°å¸«ï¼š${selectedTutor}\n`;
            }
            text += `------------------------\n`;

            targets.forEach(item => {
                text += `â° ${item.timeStr}\n`;
                text += `ğŸ« ${item.school}\n`;
                text += `ğŸ“š ${item.course} (ç¬¬${item.session}å ‚)\n`;
                if (selectedTutor === 'all') text += `ğŸ‘¨â€ğŸ« å°å¸«ï¼š${item.tutor}\n`;
                text += `\n`;
            });
            text += `è«‹æº–æ™‚å‡ºå¸­ï¼Œè¬è¬ï¼ğŸ™ğŸ»`;

            document.getElementById('promptResult').value = text;
            new bootstrap.Modal(document.getElementById('promptModal')).show();
        }

        // è¤‡è£½åˆ°å‰ªè²¼ç°¿ (ä½¿ç”¨è¼ƒæ–°çš„ API)
        function copyToClipboard() {
            let copyText = document.getElementById("promptResult");
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(copyText.value)
                    .then(() => {
                        showCopySuccess();
                    })
                    .catch(err => {
                        fallbackCopyText(copyText);
                    });
            } else {
                fallbackCopyText(copyText);
            }
        }

        function fallbackCopyText(textArea) {
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            }
        }

        function showCopySuccess(){
            // ç°¡å–®çš„æŒ‰éˆ•å›é¥‹
            let btn = document.querySelector('#promptModal .btn-accent');
            let originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> å·²è¤‡è£½ï¼';
            btn.classList.remove('btn-accent');
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-accent');
            }, 2000);
        }

    </script>
</body>
</html>
